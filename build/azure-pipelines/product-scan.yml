trigger: none
pr: none

stages:
- stage: ScanBinaries
  jobs:
  - job: VSCode
    pool:
      vmImage: VS2017-Win2016
    steps:
    - task: CredScan@2
      inputs:
        toolMajorVersion: 'V2'
    - task: NodeTool@0
      inputs:
        versionSpec: "12.14.1"

    - task: geeklearningio.gl-vsts-tasks-yarn.yarn-installer-task.YarnInstaller@2
      inputs:
        versionSpec: "1.x"

    - powershell: |
        . build/azure-pipelines/win32/exec.ps1
        $ErrorActionPreference = "Stop"
        $env:CHILD_CONCURRENCY="1"
        exec { yarn --frozen-lockfile }
      displayName: Install dependencies

    - powershell: |
        . build/azure-pipelines/win32/exec.ps1
        $ErrorActionPreference = "Stop"
        exec { yarn gulp "vscode-symbols-win32-x64" }
      displayName: Download Symbols

    - task: BinSkim@3
      inputs:
        toolVersion: Latest
        InputType:   CommandLine
        arguments:   analyze $(agent.builddirectory)\scanbin\*.dll $(agent.builddirectory)\scanbin\*.exe $(agent.builddirectory)\scanbin\*.node --recurse --local-symbol-directories $(agent.builddirectory)\scanbin\VSCode-win32-x64\pdb

    - task: TSAUpload@1
      inputs:
        tsaVersion: 'TsaV2'
        codebase: 'NewOrUpdate'
        tsaEnvironment: 'PROD'
        serviceTreeID: '79c048b2-322f-4ed5-a1ea-252a1250e4b3'
        codeBaseName: 'vscode-client'
        notificationAlias: 'sbatten@microsoft.com'
        notifyAlwaysV2: true
        codeBaseAdmins: 'REDMOND\stbatt'
        instanceUrlForTsaV2: 'MSAZURE'
        projectNameMSAZURE: 'One'
        areaPath: 'One\VSCode\Client'
        uploadAPIScan: false
        uploadBinSkim: true
        uploadCredScan: true
        uploadFortifySCA: false
        uploadFxCop: false
        uploadModernCop: false
        uploadPoliCheck: false
        uploadPREfast: false
        uploadRoslyn: false
        uploadTSLint: false
        uploadAsync: true
